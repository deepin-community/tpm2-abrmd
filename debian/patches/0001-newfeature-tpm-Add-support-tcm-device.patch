From aaeadd55da735c6b0f6eb0d5df6490c08ddbd2b9 Mon Sep 17 00:00:00 2001
From: chench <chench@hygon.cn>
Date: Fri, 12 Apr 2024 10:04:47 +0800
Subject: [PATCH 1/2] [newfeature][tpm] Add support tcm device

Change-Id: Ib2f458a13c3d147d76a95dacd9ee522cb3332b91
---
 dist/tpm2-abrmd.service.in | 4 ++--
 src/tabrmd-defaults.h      | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/dist/tpm2-abrmd.service.in b/dist/tpm2-abrmd.service.in
index b0b562c..67cf3d3 100644
--- a/dist/tpm2-abrmd.service.in
+++ b/dist/tpm2-abrmd.service.in
@@ -2,8 +2,8 @@
 Description=TPM2 Access Broker and Resource Management Daemon
 # These settings are needed when using the device TCTI. If the
 # TCP mssim is used then the settings should be commented out.
-After=dev-tpm0.device
-Requires=dev-tpm0.device
+After=dev-tpm0.device dev-tcm0.device
+Requires=dev-tpm0.device dev-tcm0.device
 
 [Service]
 Type=dbus
diff --git a/src/tabrmd-defaults.h b/src/tabrmd-defaults.h
index 7387a47..0396189 100644
--- a/src/tabrmd-defaults.h
+++ b/src/tabrmd-defaults.h
@@ -16,7 +16,7 @@
 #define TABRMD_ENTROPY_SRC_DEFAULT "/dev/urandom"
 #define TABRMD_SESSIONS_MAX_DEFAULT 4
 #define TABRMD_SESSIONS_MAX 64
-#define TABRMD_TCTI_CONF_DEFAULT "device:/dev/tpm0"
+#define TABRMD_TCTI_CONF_DEFAULT ((!access("/dev/tcm0", 0)) ? ("device:/dev/tcm0") : ("device:/dev/tpm0"))
 #define TABRMD_TRANSIENT_MAX_DEFAULT 27
 #define TABRMD_TRANSIENT_MAX 100
 
-- 
2.7.4

